<?xml version="1.0" encoding="UTF-8"?>
<database>
       <insertSQL>insert into co_operation (req_instanceId,instanceId,req_serviceId,instanceType,req_orgId,operationId,oprationType,req_UpdateTime,jobId,serviceUri, rep_status,rep_CreateTime,rep_LastModifiedTime) values(?,?,?,?,?,?,?,?,?,?,?,?,?)</insertSQL>
       <updateSQLByInsertReply>UPDATE co_operation SET jobId = ?,serviceUri = ?,rep_status = ?,rep_CreateTime = ?,rep_LastModifiedTime= ? ,req_UpdateTime= ? WHERE operationId= ?</updateSQLByInsertReply>
       <selectSQL>select req_instanceId,instanceId,req_serviceId,instanceType,req_orgId,operationId,oprationType,req_UpdateTime,jobId,serviceUri, rep_status,rep_CreateTime,rep_LastModifiedTime from co_operation where req_UpdateTime IN (SELECT MAX(req_UpdateTime) FROM co_operation) AND req_instanceId = </selectSQL>
       <selectLastRecordByInstanceId>SELECT req_instanceId, instanceId, req_serviceId, instanceType, req_orgId, operationId, oprationType, req_UpdateTime, jobId, serviceUri, rep_status, rep_CreateTime, rep_LastModifiedTime FROM co_operation WHERE req_instanceId = ? AND req_UpdateTime IN (SELECT MAX(req_UpdateTime) req_UpdateTime FROM co_operation t WHERE t.req_instanceId = ? AND rep_status = '202')</selectLastRecordByInstanceId>
       <selectUsageRecord>
		SELECT
		      m.req_instanceId
		      ,m.instanceId
		      ,m.req_serviceId
		      ,m.rep_CreateTime
		      ,m.oprationType
		      ,CASE WHEN m.startDate = m.endDate THEN 
		            CASE WHEN m.size = 'hour' THEN TIMESTAMPDIFF(hour,m.startDate,SYSDATE())
		                ELSE TIMESTAMPDIFF(day,m.startDate,SYSDATE())
		                END
		        ELSE m.usageTime
		        END AS usageTime
		      ,m.startDate
		      ,CASE WHEN m.startDate = m.endDate THEN SYSDATE() ELSE m.endDate END AS endDate
		FROM (
		   SELECT
		      t.req_instanceId
		      ,t.instanceId
		      ,t.req_serviceId
		      ,t.rep_CreateTime
		      ,t.oprationType
		      ,s.size
		      ,CASE WHEN s.size = 'hour' THEN TIMESTAMPDIFF(hour,MIN(t.rep_CreateTime),MAX(t.rep_CreateTime))
		            ELSE TIMESTAMPDIFF(day,MIN(t.rep_CreateTime),MAX(t.rep_CreateTime))
		       END AS usageTime
		      ,MIN(t.rep_CreateTime) AS startDate
		      ,MAX(t.rep_CreateTime) AS endDate
		   FROM
		       co_operation t,
		       (SELECT ? AS size FROM dual) s  -- 单独传入参数，为了调用TIMESTAMPDIFF时，去掉单引号 'hour' =>hour
		   WHERE
		       t.req_serviceId = ?
		       AND t.oprationType IN ('create', 'delete')
		       AND t.rep_status = '202'
		       AND t.rep_CreateTime BETWEEN ? AND DATE_ADD(?,INTERVAL 1 DAY)
		   GROUP BY t.req_instanceId, t.instanceId
		   ORDER BY t.rep_CreateTime
		   ) m
		   WHERE m.oprationType != 'delete'
       </selectUsageRecord>
       <insertSQLByWhere>wanghl6@citic.com</insertSQLByWhere>
</database>